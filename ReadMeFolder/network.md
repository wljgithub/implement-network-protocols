
# IP

IP 是TCP/IP协议族中最核心的协议，所有的TCP、UDP、IGMP数据都以IP数据报的格式传输。
IP主要有两个特点：

- 无连接
- 不可靠

无连接：指的是每个ip数据报都独立地进行路由跳转，可能会选择不同路由跳转，可以不按顺序接受

不可靠：指的是，ip数据报只提供传输服务，并不能保证数据报到达目的地，当出现错误时(如路由器用完缓冲区)，则发送ICMP报到信源端

### IP首部

ip首部最大为20字节，不过一般的ip首部(不含选项的)长度为5字节，来张图更直观些

![](https://github.com/wljgithub/implement_network_protocols/blob/master/ReadMeFolder/resourse/ipHead.jpg)	

下面来详细介绍下其中的字段含义：

第一行

版本：ip版本号，ipv4 or ipv6

首部长度：即为上图中的行数，一般的ip首部长度为5(不含选项)

区分服务(TOS):设置最小时延、最大吞吐量、最高可靠性、最小费用，如上层的协议Telenet需要最小传输时延，FTP需要最大吞吐量等，但大多数TCP/IP实现都不支持TOS特性

第二行

标识：

标记：

片偏移：

第三行

生存时间(TTL)：设置最大路由跳转次数

协议： 上层的协议，ICMP:1 IGMP:2  ,TCP:6 UDP:17

首部检验和：根据IP首部计算的检验和码(不含首部后的数据)，用于检验传输过程中是否出差错。如果出错，IP丢弃收到的数据报，但不生成差错报文，由上层的协议进行发现并重传

### IP路由选择

一般情况下IP可以从上层的协议(TCP、UDP)中接受到数据报，或从下层的网卡中接受到数据报(待转发的数据报)。

每当接受到一份数据报时，都会对内存中的路由表进行搜索，如果是本机的ip地址之一(因为可能会有多个网卡)或ip广播地址，则会根据ip首部中的协议字段往对应的协议往上层传。如若不是这些地址，则看是否开启ip转发功能，未开启则将数据报丢弃。

若开启：

1. 则搜索路由表查看与目的ip地址完全匹配的条目(<b>网络号和主机号</b>都要相匹配)，如果找到，则将报文发送给下一跳的路由或直接连接的网络接口(取决于路由表中标志字段的值)

2. 搜索路由表，寻找<b>网络号</b>与之匹配到条目，执行相应的路由跳转,局域网中的主机都是通过这种方式寻址的

3. 搜索路由表，执行<b>默认</b>条目的路由跳转

如果上述操作都失败了，则发送一条 网络不可达或 主机不可达的ICMP报文到信源端

	在window中可以通过 route print 来查看路由表 ，0.0.0.0代表默认路由


### 子网掩码与子网寻址

子网掩码是一个32bit的值，用来区分网络号和主机号，就像这样的一串数字 11111111 1111111 1111111 00000000 ,不过一般用10进制来表示，255.255.255.0 。全为1代表为网络号，全为0代表主机号。

比如一个ip地址为 192.168.1.2， 子网掩码为：255.255.255.0 ,则表示 192.168.1为网络号，2为主机号


子网寻址是用来缩小路由表的规模。。。待续