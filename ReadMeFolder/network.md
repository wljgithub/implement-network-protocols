# 链路层

TCP/IP支持不同的链路层协议，至于具体用什么协议取决于网络所使用的硬件，如以太网、令牌环网、FDDI。

## 以太网

以太网（英语：Ethernet）是一种计算机局域网技术。IEEE组织的IEEE 802.3标准制定了以太网的技术标准，它规定了包括物理层的连线、电子信号和介质访问层协议的内容。以太网是目前应用最普遍的局域网技术，取代了其他局域网标准如令牌环、FDDI和ARCNET。

下面是以太网数据封装的格式：
![](https://github.com/wljgithub/implement_network_protocols/blob/master/ReadMeFolder/resourse/ethernet.jpg)	

## PPP
PPP(Point To Point)点对点协议，是链路层的一个协议，设计目的主要是用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机、网桥和路由器之间简单连接的一种共通的解决方案。PPPOE就是基于PPP协议的

## 环回接口

环回接口，允许运行在同一台主机上的客户端和服务器进行通信，大多数操作系统把 127.0.0.1分配给这个接口，并命名为localhost

一个传给环回接口的ip数据报，在网络层的时候就返回给自己了，所以如果你用WireShark抓包发现什么也没有，因为WireShark监听的是某块网卡，而网卡属于数据链路层

## MTU
以太网和IEEE 802对数据帧的长度都有一个限制，其最大值分别是1500和1492字节，而这个限制就叫做MTU(Maximum Transmission Unit),即最大传输单元

如果网络层要传输的数据大于MTU，就会对数据进行分片处理，每一片都小于MTU


下面给出一张链路层各个实现的MTU值：

![](https://github.com/wljgithub/implement_network_protocols/blob/master/ReadMeFolder/resourse/mtu.jpg)	



# 网络层

## IP

IP(internet protocol) 是TCP/IP协议族中最核心的协议，所有的TCP、UDP、IGMP数据都以IP数据报的格式传输。
ip主要有两个特点：

- 无连接
- 不可靠

无连接：指的是每个ip数据报都独立地进行路由跳转，可能会选择不同路由跳转，可以不按顺序接受

不可靠：指的是，ip数据报只提供传输服务，并不能保证数据报到达目的地，当出现错误时(如路由器用完缓冲区)，则发送ICMP报到信源端

#### IP首部

ip首部最大为20字节，不过一般的ip首部(不含选项的)长度为5字节，来张图更直观些

![](https://github.com/wljgithub/implement_network_protocols/blob/master/ReadMeFolder/resourse/ipHead.jpg)	

下面来详细介绍下其中的字段含义：

第一行

版本：ip版本号，ipv4 or ipv6

首部长度：即为上图中的行数，一般的ip首部长度为5(不含选项)

区分服务(TOS):设置最小时延、最大吞吐量、最高可靠性、最小费用，如上层的协议Telenet需要最小传输时延，FTP需要最大吞吐量等，但大多数TCP/IP实现都不支持TOS特性

第二行

标识：

标记：

片偏移：

第三行

生存时间(TTL)：设置最大路由跳转次数

协议： 上层的协议，ICMP:1 IGMP:2  ,TCP:6 UDP:17

首部检验和：根据IP首部计算的检验和码(不含首部后的数据)，用于检验传输过程中是否出差错。如果出错，IP丢弃收到的数据报，但不生成差错报文，由上层的协议进行发现并重传

#### IP路由选择

一般情况下IP可以从上层的协议(TCP、UDP)中接受到数据报，或从下层的网卡中接受到数据报(待转发的数据报)。

每当接受到一份数据报时，都会对内存中的路由表进行搜索，如果是本机的ip地址之一(因为可能会有多个网卡)或ip广播地址，则会根据ip首部中的协议字段往对应的协议往上层传。如若不是这些地址，则看是否开启ip转发功能，未开启则将数据报丢弃。

若开启：

1. 则搜索路由表查看与目的ip地址完全匹配的条目(<b>网络号和主机号</b>都要相匹配)，如果找到，则将报文发送给下一跳的路由或直接连接的网络接口(取决于路由表中标志字段的值)

2. 搜索路由表，寻找<b>网络号</b>与之匹配到条目，执行相应的路由跳转,局域网中的主机都是通过这种方式寻址的

3. 搜索路由表，执行<b>默认</b>条目的路由跳转

如果上述操作都失败了，则发送一条 网络不可达或 主机不可达的ICMP报文到信源端

	在window中可以通过 route print 来查看路由表 ，0.0.0.0代表默认路由


#### 子网掩码与子网寻址

子网掩码是一个32bit的值，用来区分网络号和主机号，就像这样的一串数字 11111111 1111111 1111111 00000000 ,不过一般用10进制来表示，255.255.255.0 。全为1代表为网络号，全为0代表主机号。

比如一个ip地址为 192.168.1.2， 子网掩码为：255.255.255.0 ,则表示 192.168.1为网络号，2为主机号


子网寻址是用来缩小路由表的规模。。。待续

#ARP

ARP(address resolve protocol),翻译过来即为 地址解析协议,在同一个局域网中时，不同的主机是直接根据mac地址来通信的，一开始并不知道目的地mac地址，是根据目的ip地址来查询相应的mac地址的。

#### 具体过程

比如同个局域网下的主机A想和主机B通信，

主机A的IP地址为192.168.1.1，MAC地址为0A-11-22-33-44-01；

主机B的IP地址为192.168.1.2，MAC地址为0A-11-22-33-44-02；

第一步： 主机A先检查路由表，得知主机B的转发IP为192.168.1.2，再从arp缓存表中找出192.168.1.2对应的mac地址

第二步： 如果找不到，发送一个arp请求的数据帧到局域网中的每一台主机，这个过程称之为广播，局域网中的每一台主机都会接收到数据帧，并检查请求中目的ip是否与自己的ip相匹配，如果不匹配则将请求丢弃

第三步：如果主机B确认请求中的IP与自己的相匹配，则将A的mac地址保存在arp缓存中

第四步：主机B将直接返回一个包含自身mac地址的arp应答(因为有目的地的mac地址，所以不需要通过广播的方式，可直接通信)

第五步： 主机A收到arp应答后，并不会检验报文的真实性，就将主机B的ip地址和mac地址存入arp缓存表中

#### ARP遗留的漏洞

上面谈到，因为主机收到arp应答后，并不会验证报文的真实性，直接将其存入arp缓存表中，所以这就造成一个漏洞。

即局域网中任何一台主机都可以伪造网关发送一个arp应答到目标主机，目标主机并不会验证arp报文的真实性，这样就可以冒充网关。然后造成所有流量都转发到这台主机上，实现流量劫持，这就是所谓的arp欺骗。

#### ARP代理

代理ARP的使用一般是使用在没有配置默认网关和路由策略的网络上的。
代理ARP的工作过程如下：
PC1和PC2虽然属于不同的广播域，但它们处于同一网段中，因此PC1会向PC2发出ARP请求广播包，请求获得PC2的MAC地址。由于路由器不会转发广播包，因此ARP请求只能到达路由器，不能到达PC2。

当在路由器上启用ARP代理后，路由器会查看ARP请求，发现IP地址172.16.20.100属于它连接的另一个网络，因此路由器用自己的接口MAC地址代替PC2的MAC地址，向PC1发送了一个ARP应答。

PC1收到ARP应答后，会认为PC2的MAC地址就是00-00-0c-94-36-ab，不会感知到ARP代理的存在。

在PC1的ARP表中可以能看到如下ARP条目：
C:\>arp -a
Interface: 172.16.10.100 --- 0x2
Internet Address Physical Address Type
172.16.20.100 00-00-0c-94-36-ab dynamic
 
在接下来的数据通信中，PC1先将数据发送给路由器，由路由器转发给PC2。

#### RARP
逆地址解析协议（Reverse Address Resolution Protocol，RARP),RARP使用与ARP相同的报头结构，作用与ARP相反。RARP用于将MAC地址转换为IP地址。其因为较限于IP地址的运用以及其他的一些缺点，因此渐为更新的BOOTP或DHCP所取代。

### 广播

一般情况下，网卡只能接受mac地址为自己的mac地址或为广播地址的的数据帧，否则则丢弃数据帧

广播地址也分为几类，如:

- 受限的广播
- 指向网络的广播
- 指向内网的广播

#### 受限的广播

一般常看到的255.255.255.255这个IP地址，是一个广播地址，但是路由器不会转发改地址的数据报，只能在本地网络中，所以称为受限的广播地址

#### 指向内网的广播

指向内网的广播ip地址的主机号全为1，如A类网络的广播的地址为 netid.255.255.255, netid为A类网络中的网络号

路由器必须转发指向网络的广播，但它也必须有一个不进行转发的选择

#### 指向子网的广播

指向子网的广播地址主机号全为1且有特定的子网号，作为子网直接广播地址的ip地址需要了解子网的掩码

例如，如果路由器收到发往128.1.2.155的数据报，当B类网络128.1的子网盐，啊为255.255.255.0时，该地址就是指向子网的广播地址；但如果该子网的掩码为255.255.254.0，该地址就不是指向子网的广播地址





# FAQ

A：路由器怎么知道下一跳的mac地址，他们又不属于同一个局域网。

A:为什么数据报在路由跳转过程中，目的ip不会变，而目的mac地址却每一跳几次都会变？
Q：数据报在执行路由跳转的过程中先搜索路由表，然后执行相应的路由跳转，在确认是下一跳的主机后，两台主机之间的通信，数据报往下层传递(数据链路层)必须需要mac地址，所以会根据arp协议根据ip查询对应的mac地址，然后才能通信。

A： 如果arp查询时，填入的是一个无效的ip会怎么样？